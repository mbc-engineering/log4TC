<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" 
     xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util" 
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
   <!-- Debug setup:
    msiexec.exe /i "xxx.Setup(x64)v19.7.14.9.msi" /l*v install.log-->

  <!-- Help links:
  - cookbook pdf -> https://docs.google.com/viewer?a=v&pid=sites&srcid=ZGVmYXVsdGRvbWFpbnxzZWNyZXRzb2Z3ZWJ8Z3g6NGY2ZmVmZjcyMmE2ZmFiMw
  - sample harvesting files: https://www.codeproject.com/Articles/1107786/%2FArticles%2F1107786%2FEnabling-Harvest-Heat-exe-in-a-Wix-Setup-Project
  - heatdirectory Task parameters: http://wixtoolset.org/documentation/manual/v3/msbuild/task_reference/heatdirectory.html
  - binding definitions like !(bind.packageManufacturer.MyProduct): http://wixtoolset.org/documentation/manual/v3/overview/light.html
  - UI Customization: https://wixtoolset.org/documentation/manual/v3/wixui/wixui_customizations.html
  -->

  <!--#####################################
     Includes, Defines & Variables
     ######################################-->
  <?include $(sys.CURRENTDIR)Includes/DefinitionsPlatform.wxi ?>
  <?define ProductVersion = "$(BuildVersion)"?>
  <?define UpgradeCode = "E018EB69-CA90-463B-85DC-8D2ABB93A6BA" ?>

  <!--#####################################
     Product definition
     ######################################-->
  <Package Name="mbc engineering log4TC v$(var.ProductVersion) $(var.bitness)" Language="1033" Version="$(var.ProductVersion)" Manufacturer="mbc engineering" UpgradeCode="$(var.UpgradeCode)">
    <SummaryInformation Description="mbc engineering log4Tc" Manufacturer="mbc engineering" />
    <MediaTemplate EmbedCab="yes" />


    <!-- Exits successfully in the case newer version are already installed -->
    <util:ExitEarlyWithSuccess />
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." AllowDowngrades="no" AllowSameVersionUpgrades="yes" /> <!-- AllowSameVersionUpgrades is for the 4. Version place, use WIX_UPGRADE_DETECTED Property to know if new version installation is dedected -->


    <!-- Setup UI customization
         ********************** -->
    <WixVariable Id="WixUILicenseRtf" Value="EULA.rtf" />
    <UI>
      <!-- one of the alternatives Simplest: <UIRef Id="WixUI_Minimal"/> or <UIRef Id="WixUI_InstallDir"/> -->
      <ui:WixUI Id="WixUI_FeatureTree" />
    </UI>
    <!-- Set the icon to show next to the program name in Windows Add/Remove programs -->
    <Icon Id="favicon.ico" SourceFile="$(sys.CURRENTDIR)Resources/favicon.ico" />
    <Property Id="ARPPRODUCTICON" Value="favicon.ico" />
    <!-- Installer UI custom pictures. -->
    <WixVariable Id="WixUIBannerBmp" Value="$(sys.CURRENTDIR)Resources/MbcBanner.png" />
    <WixVariable Id="WixUIDialogBmp" Value="$(sys.CURRENTDIR)Resources/log4TcBackground.png" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Tipp: Schaue die get started Dokumentation an." />

    <!-- Installation prerequisite
         ************************ -->
    <!-- 602 = Windows8; 601 = Windows 7, 603 = Windows 8.1; 603 = Windows 10; 603 = Windows 11 https://docs.microsoft.com/en-us/windows/win32/msi/operating-system-property-values -->
    <Launch Condition="Installed OR VersionNT &gt;= 603" Message="Nur Windows 10 und neuer wird unterstützt" />

    <!-- Installer Feature list
         ********************** -->
    <PropertyRef Id="WIX_IS_TWINCAT3_ROUTER_INSTALLED" />
    <PropertyRef Id="WIX_IS_TWINCAT3_XAE_INSTALLED" />
    <Feature Id="Log4TcServiceFeature" Title="log4TC Service" Description="log4TC Service und Ausgabe Kanäle installieren und Service starten" Level="0">

      <!-- no requirements -->
      <Level Value="1" Condition="1" /> <!-- Ignore condition, requires TwinCat Router are installed: Condition="Installed OR WIX_IS_TWINCAT3_ROUTER_INSTALLED" /> -->

      <!-- Cmp_Log4TcService is generated by Heat Harvesting as BeforeBuild task -->
      <ComponentGroupRef Id="Cmp_Log4TcService" />
      <ComponentGroupRef Id="Cmp_Log4TcServiceInstall" />
      <ComponentGroupRef Id="Cmp_Log4TcServiceOutputFiles" />
      <ComponentGroupRef Id="Cmp_Log4TcCommonInstall" />
    </Feature>
    <Feature Id="Log4TcTwinCatLibFeature" Title="log4TC TwinCat 3.2024 Bibliothek" Description="log4TC TwinCat 3.2024 Bibliothek installieren" Level="0">

      <!-- Check Feature prerequisites are installed, when not feature is not visible
           - requires TwinCat XAE -->
      <Level Value="1" Condition="Installed OR (WIX_IS_TWINCAT3_XAE_INSTALLED&lt;&gt;0 AND WIX_IS_TWINCAT3_BUILD_4022_OR_LATER_INSTALLED)" />

      <ComponentGroupRef Id="Cmp_Log4TcTwinCatLib" />
      <ComponentGroupRef Id="Cmp_Log4TcCommonInstall" />
    </Feature>
    <!-- ToDo: TwinCAT 2024 installation location!-->
    <Feature Id="Log4TcGettingStartedFeature" Title="log4TC TwinCat 3 Getting Started" Description="log4TC TwinCat 3 Bibliothek Getting Started installieren" Level="0">

      <!-- no requirements -->
      <Level Value="1" Condition="1"/>

      <ComponentGroupRef Id="Cmp_Log4TcTwinCatLibGettingStartedFiles" />
      <ComponentGroupRef Id="Cmp_Log4TcTwinCatLibGettingStarted" />
      <ComponentGroupRef Id="Cmp_Log4TcCommonInstall" />
    </Feature>

    <!-- Installation Custom Actions
         ************************ -->
    <!--set CustomActionData values for actions to use-->
    <CustomAction Id="CA_Log4TcTwinCatLibRepToolInstall" DllEntry="WixQuietExec" Execute="deferred" Return="check" BinaryRef="Wix4UtilCA_X86" />
    <Property Id="Twincat3Profile" Value="TwinCAT PLC Control" />
    <!-- Execute install command "RepTool.exe [dashdash]profile="c:\TwinCAT\3.1\Components\Plc\Profiles\TwinCAT PLC Control" [dashdash]installLib "C:\mbc-source\mbc\log4tc\library\mbc_Log4TC_v.0.0.2.library"-->
    <SetProperty Id="CA_Log4TcTwinCatLibRepToolInstall" Value="&quot;[DIR_Twincat3Common]RepTool.exe&quot; --profile=&quot;[DIR_Twincat3Profiles][Twincat3Profile]&quot; --installLib &quot;[#Log4TcTwinCatLibFile]&quot;" Sequence="execute" Before="CA_Log4TcTwinCatLibRepToolInstall" />

    <InstallExecuteSequence>
      <!-- Install TwincatLib when value == 3 (3-> on install; 2-> on deinstall)-->
      <Custom Action="CA_Log4TcTwinCatLibRepToolInstall" After="InstallFiles" Condition="&amp;Log4TcTwinCatLibFeature=3" />
    </InstallExecuteSequence>
  </Package>


  <!--Directory structure
      ******************* -->
  <Fragment><SetDirectory Id="DIR_Twincat3" Value="[WIX_TWINCAT31_INSTALLDIR]" />
  
      <Directory Id="$(var.PlatformProgramFilesFolder)">
        <Directory Id="ManufacturerFolder" Name="!(bind.property.Manufacturer)">
          <Directory Id="DIR_Log4TcService" Name="log4TC">
          </Directory>
        </Directory>
      </Directory>

      <StandardDirectory Id="ProgramMenuFolder">
        <Directory Id="DIR_ProgramMenuServiceShortcuts" Name="log4TC" />
      </StandardDirectory>

      <StandardDirectory Id="CommonAppDataFolder">
        <Directory Id="DIR_CommonAppDataFolderLog4Tc" Name="log4TC">
          <Directory Id="DIR_CommonAppDataFolderLog4TcConfig" Name="config" />
          <Directory Id="DIR_CommonAppDataFolderLog4TcLog" Name="log" />
          <Directory Id="DIR_CommonAppDataFolderLog4TcLib" Name="lib" />
          <Directory Id="DIR_CommonAppDataFolderLog4TcGettingStarted" Name="getting started" />
        </Directory>
      </StandardDirectory>

      <!-- Define existing TwinCat installation directories-->
      <Directory Id="DIR_Twincat3">
        <Directory Id="DIR_Twincat3Components" Name="Components">
          <Directory Id="DIR_Twincat3Plc" Name="Plc">
        <Directory Id="DIR_Twincat3Common" Name="Common" />
          <Directory Id="DIR_Twincat3Profiles" Name="Profiles" />
          </Directory>
          </Directory>
      </Directory>
    </Fragment>
</Wix>
